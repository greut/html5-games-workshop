<!DOCTYPE html>
<html>
  <head>
    <title>Atelier jeux HTML5 - Ennemis</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="../../../../css/styles.css"/>
    <link rel="stylesheet" href="../../../../vendor/prism/prism.css"/>
    <script src="../../../../vendor/prism/prism.js"></script>
  </head>
  <body>
    <header class="main-header">
      <h1><a href="../../..">Atelier jeux HTML5</a></h1>
    </header>
    <main>
      <article>
        <p>Également disponible en <a href="../../../../en/guides/platformer/walking-enemies">en</a>.
        </p>
        <h1>Ennemis</h1><p>Le seul challenge du jeu en l&#39;état est de sauter correctement. Ni super fun, ni compliqué étant donné qu&#39;il n&#39;est pas possible de sortir de l&#39;univers. Il est temps d&#39;ajout du danger sous forme d&#39;ennemis velus.</p>
<p>Voici l&#39;impressionnate araignée!</p>
<p><img src="/html5-games-workshop/assets/platformer/walking_spider.gif" alt="Walking spider"/></p>
<p>Cet ennemi possède un comportement simple : il se déplace horizontalement de gauche à droite sans tomber des plateformes ou traverser les murs.</p>
<p>L&#39;araignée est animée à l&#39;aide la feuille de sprite suivante.</p>
<p><img src="/html5-games-workshop/assets/platformer/invisible_walls.png" alt="Invisible walls"/></p>
<p>Pour que l&#39;araignée ne tombe pas des plateformes, nous allons utiliser un truc nommé <strong>murs invisibles</strong>. Ces murs seront des sprites, avec un corps physique, mais masqués. Le héros les ignorera complétement mais pas les araignées qui les toucheront et feront demi-tour.</p>
<p>Voici à quoi ressembleraient les murs, s&#39;il étaient affichés. Il y a un au bord
de chaque plateforme.</p>
<p><img src="/html5-games-workshop/assets/platformer/invisible_walls.png" alt="Invisible walls"/></p>
<h1 id="t-ches">Tâches</h1>
<h2 id="cr-er-le-sprite-pour-l-ennemi">Créer le sprite pour l&#39;ennemi</h2>
<ol>
<li><p>Précharger l&#39;image liée à l&#39;araignée dont chaque sprite fait <code>42×32</code>.</p>
<pre><code class="lang-js"> PlayState.preload = function () {
     // ...
     this.game.load.spritesheet(&#39;spider&#39;, &#39;images/spider.png&#39;, 42, 32);
 };
</code></pre>
</li>
<li><p>Comme pour le héros, ne devons spécialiser un <code>Phaser.Sprite</code> gérant la vie d&#39;une araignée. Dans le constructeur, nous activons la physique et ajoutons deux animations : une de marche et une autre de mort.</p>
<pre><code class="lang-js"> function Spider(game, x, y) {
     Phaser.Sprite.call(this, game, x, y, &#39;spider&#39;);

     this.anchor.set(0.5, .5);
     // animations
     this.animations.add(&#39;crawl&#39;, [0, 1, 2], 8, true);
     this.animations.play(&#39;crawl&#39;);

     // physique
     this.game.physics.enable(this);
     this.body.collideWorldBounds = true;
     this.body.velocity.x = -this.SPEED;
 }

 // inherit from Phaser.Sprite
 Spider.prototype = Object.create(Phaser.Sprite.prototype);
 Spider.prototype.constructor = Spider;
 Spider.prototype.SPEED = 100;
</code></pre>
</li>
</ol>
<h2 id="afficher-les-araign-es">Afficher les araignées</h2>
<ol>
<li><p>Le fichier JSON du niveau contient les informations des araignées <code>spiders</code> devant être crées. Il est important de créer un groupe pour elles afin de simplifier la gestion des collisions.</p>
<pre><code class="lang-js"> PlayState._loadLevel = function (data) {
     // ...
     this.coins = this.game.add.group();
     this.spiders = this.game.add.group();
     // ...

     this.spawnCharacters({hero: data.hero, spiders: data.spiders});
 };
</code></pre>
</li>
<li><p>Depuis la création des caractères, créons chaque araignée avec un boucle <code>forEach</code>.</p>
<pre><code class="lang-js"> PlayState._spawnCharacters = function (data) {
     // ...
     data.spiders.forEach(function (spider) {
         let sprite = new Spider(this.game, spider.x, spider.y);
         this.spiders.add(sprite);
     }, this);
 };
</code></pre>
</li>
<li><p>On essaie... et paf! C&#39;est la catastrophe.</p>
<p> <img src="/html5-games-workshop/assets/platformer/spider_disaster.gif" alt="Spiders affected by gravity"/></p>
<p> Les araignées se cassent la gueule car elles subissent la gravitation, sont restreintes par les limites du monde mais ne possède pas de collisions avec les plateformes.</p>
</li>
</ol>
<h2 id="r-soudre-les-collisions">Résoudre les collisions</h2>
<ol>
<li><p>La première étape est d&#39;ajoute une collision entre araignées et plateformes.</p>
<pre><code class="lang-js"> PlayState._handleCollisions = function () {
     this.game.physics.arcade.collide(this.spiders, this.platforms);
     // ...
 };
</code></pre>
<p> Les araignées tombent des plateformes à présent.</p>
</li>
</ol>
<h2 id="ajouter-les-murs-invisibles">Ajouter les murs invisibles</h2>
<ol>
<li><p>Ajoutons les murs invisibles pour prévenir d&#39;horribles chutes aux araignées. Il est important de précharger l&#39;image, qui ne sera pas affichée mais servira a définir la taille des murs.</p>
<pre><code class="lang-js"> PlayState.preload = function () {
     // ...
     this.game.load.image(&#39;invisible-wall&#39;, &#39;images/invisible_wall.png&#39;);
     // ...
 };
</code></pre>
</li>
<li><p>Ajouter ces murs à un groupe permettra de gérer les collisions avec les araignées.</p>
<pre><code class="lang-js"> PlayState._loadLevel = function (data) {
     // ...
     this.spiders = this.game.add.group();
     this.enemyWalls = this.game.add.group();
     // ...
 };
</code></pre>
</li>
<li><p>Pour chaque plateforme, il faut créer deux faux murs à gauche et droite de la plateforme. L&#39;ancre en x vallant parfois <code>0</code>, parfois <code>1</code> va permettre d&#39;aligne à gauche ou droite le mur par rapport au bord de la plateform.</p>
<pre><code class="lang-js"> PlayState.spawnPlatform = function (platform) {
     // ...
     this.spawnEnemyWall(platform.x, platform.y, &#39;left&#39;);
     this.spawnEnemyWall(platform.x + sprite.width, platform.y, &#39;right&#39;);
 };
</code></pre>
<pre><code class="lang-js"> PlayState._spawnEnemyWall = function (x, y, side) {
     let sprite = this.enemyWalls.create(x, y, &#39;invisible-wall&#39;);
     // ancrage en y et décalage en x.
     sprite.anchor.set(side === &#39;left&#39; ? 1 : 0, 1);

     // physique
     this.game.physics.enable(sprite);
     sprite.body.immovable = true;
     sprite.body.allowGravity = false;
 };
</code></pre>
</li>
<li><p>Ajoutons les collisions entre les faux-murs et les araignées afin qu&#39;elles ne puissent les traverser.</p>
<pre><code class="lang-js"> PlayState.handleCollisions = function () {
     this.game.physics.arcade.collide(this.spiders, this.platforms);
     this.game.physics.arcade.collide(this.spiders, this.enemyWalls);
     // ...
 };
</code></pre>
</li>
<li><p>À présent, les araignées se bloquent contre les plateformes.</p>
<p> <img src="/html5-games-workshop/assets/platformer/spider_vs_wall.png" alt="Spider blocked by wall"/></p>
</li>
<li><p>Il semble qu&#39;on peut masquer les faux-murs en mettant la propriété <code>visible</code> à faux <code>false</code>.</p>
<pre><code class="lang-js"> PlayState._loadLevel = function (data) {
     // ...
     this.enemyWalls = this.game.add.group();
     this.enemyWalls.visible = false;
     // ...
 };
</code></pre>
</li>
</ol>
<h2 id="d-bloquer-les-araign-es">Débloquer les araignées</h2>
<ol>
<li><p>Nous avons vu qu&#39;il existe un valeur nommée <code>touching</code> permettant de savoir si le corps physique touche un autre élément. Ce que nous allons utiliser pour changer de sens l&#39;araignée bloquée.</p>
<p> Cependant, nous devons également effectué un autre test avec bloqué <code>blocked</code> pour savoir si l&#39;araignée est face aux limites du monde.</p>
<p> Ajoutons une méthode mise-à-jour <code>update</code> à l&#39;araignée. Cette méthode est appelée <strong>automatiquement</strong> par Phaser chaque frame. Il est important de placer ceci <em>après</em> avoir copié le <code>prototype</code> du parent.</p>
<pre><code class="lang-js"> Spider.prototype.update = function () {
     // check against walls and reverse direction if necessary
     if (this.body.touching.right || this.body.blocked.right) {
         this.body.velocity.x = -this.SPEED;
         this.scale.x *= -1
     }
     else if (this.body.touching.left || this.body.blocked.left) {
         this.body.velocity.x = this.SPEED;
         this.scale.x *= -1
     }
 };
</code></pre>
</li>
</ol>
<p>Et voilà, les araignées se déplacent et se retournent au changement de sens.</p>
<p><img src="/html5-games-workshop/assets/platformer/spider_turning.gif" alt="Spider turning into the opposite direction"/></p>
<h1 id="v-rifications">Vérifications</h1>
<ul>
<li>Trois araignées toutes mignonnes se déplacent sur les plateforme sans en choïr ni passer à travers.</li>
<li>Les araignées font demi-tour si elle rencontre un obstacle ou le bord d&#39;une plateforme.</li>
<li>Le héros n&#39;influe aucunement sur la vie des araignées.</li>
</ul>

        <h2>Téléchargement</h2>
        <p>Êtes-vous bloqué? Jetez un œil <a href="../../../../assets/platformer/steps/step10.js" télécharger="">au code source</a> de cette étape.
        </p>
        <nav class="paginated-nav">
          <ul>
            <li class="previous">« Prédédent:&nbsp;<a href="../passe-la-monnaie">Passe la monnaie</a></li>
            <li class="next">Suivant:&nbsp;<a href="../mort">Mort</a>&nbsp;»</li>
          </ul>
        </nav>
      </article>
    </main>
    <footer class="main-footer">
      <p>Propulsé avec amour,<br/>par les fées de chez <a href="https://mozilla.org">Mozilla</a>.</p>
    </footer>
  </body>
</html>